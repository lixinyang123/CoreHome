name: build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        language: [ 'csharp', 'javascript' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v1
      with:
        languages: ${{ matrix.language }}

    - name: Autobuild
      uses: github/codeql-action/autobuild@v1

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v1

  build-image:
    # needs: Analyze
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: Build CoreHome.Admin
      run: docker build --file ./CoreHome.Admin/Dockerfile --tag lixinyang/corehome-admin:latest .
    
    - name: Build CoreHome.HomePage
      run: docker build --file ./CoreHome.HomePage/Dockerfile --tag lixinyang/corehome-homepage:latest .

    - name: Build CoreHome.ReverseProxy
      run: docker build --file ./CoreHome.ReverseProxy/Dockerfile --tag lixinyang/corehome-reverseproxy:latest .
    
    - name: Push image to DockerHub
      run: |
        docker login -u lixinyang -p ${{ secrets.DOCKERHUB_PASSWORD }}
        docker push lixinyang/corehome-admin:latest
        docker push lixinyang/corehome-homepage:latest
        docker push lixinyang/corehome-reverseproxy:latest
        docker logout
    
    - name: Push image to aliyun
      run: |
        docker login -u=lllxyÂïäÂïäÂïä -p ${{ secrets.DOCKERHUB_PASSWORD }} registry.cn-shenzhen.aliyuncs.com
        docker tag lixinyang/corehome-admin:latest registry.cn-shenzhen.aliyuncs.com/lllxy/corehome-admin:latest
        docker push registry.cn-shenzhen.aliyuncs.com/lllxy/corehome-admin:latest
        docker tag lixinyang/corehome-homepage:latest registry.cn-shenzhen.aliyuncs.com/lllxy/corehome-homepage:latest
        docker push registry.cn-shenzhen.aliyuncs.com/lllxy/corehome-homepage:latest
        docker tag lixinyang/corehome-reverseproxy:latest registry.cn-shenzhen.aliyuncs.com/lllxy/corehome-reverseproxy:latest
        docker push registry.cn-shenzhen.aliyuncs.com/lllxy/corehome-reverseproxy:latest
        docker logout


  build-myhome:
    # needs: Analyze
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Add EasterEggs
      run: |
        cat >> ./CoreHome.HomePage/Views/Home/Index.cshtml << EOF
        <script src="https://cdn.bootcss.com/JQuery-Snowfall/1.7.4/snowfall.jquery.min.js"></script>
        <style>
            #EasterEggs {
                cursor: pointer;
            }
            .snowfall-flakes:before {
                content: "";
                position: absolute;
                left: 0px;
                top: 0px;
                width: 10px;
                height: 16px;
                transform: rotate(-45deg);
                background-color: red;
                border-radius: 5px 5px 1px 1px;
            }
            .snowfall-flakes:after {
                content: "";
                position: absolute;
                left: 0px;
                top: 0px;
                width: 10px;
                height: 16px;
                transform: translateX(4.3px) rotate(45deg);
                background-color: red;
                border-radius: 5px 5px 1px 1px;
            }
        </style>
        <script>
            function toDouble(num) {
                num >= 10 ? num = '' + num : num = '0' + num;
                return num;
            }
            function timer(year, month, day, hour, minute, seconds, elem) {
                var hour = hour || 0,
                    minute = minute || 0,
                    seconds = seconds || 0;
                var endTime = new Date();
                endTime.setFullYear(parseInt(year)),
                    endTime.setMonth(parseInt(month) - 1),
                    endTime.setDate(parseInt(day)),
                    endTime.setHours(parseInt(hour)),
                    endTime.setMinutes(parseInt(minute)),
                    endTime.setSeconds(parseInt(seconds));
                setTime();
                setInterval(function () {
                    setTime()
                }, 1000);
                function setTime() {
                    var startTime = new Date();
                    var lengthTime = parseInt((startTime.getTime() - endTime.getTime()) / 1000);
                    var lSeconds = parseInt(lengthTime % 60),
                        lMinute = parseInt((lengthTime / 60) % 60),
                        lHour = Math.floor((lengthTime / 3600) % 24),
                        lDay = Math.floor(lengthTime / (24 * 3600));
                    elem.innerHTML = "ËÆ§ËØÜ‰Ω†ÁöÑÁ¨¨" + lDay + 'Â§©' + toDouble(lHour) + 'Â∞èÊó∂' + toDouble(lMinute) + 'ÂàÜÈíü' + toDouble(lSeconds) + 'Áßí';
                }
            }
            var isShowed = false;
            function showEasterEggs() {
                if (!isShowed) {
                    typed.destroy();
                    \$(document).snowfall({ flakeCount: 100, maxSpeed: 5 });
                    document.querySelector("#avatar").src = "https://corehome.oss-accelerate.aliyuncs.com/images/f.jpg";
                    document.querySelector("#name").innerText = "f j h";
                    timer(2020, 03, 18, 0, 0, 0, document.querySelector("#info"));
                    document.querySelector("#qq").innerText = "Áà±‰Ω†Âì¶ÔΩûÔΩû"
                    document.querySelector("#email").innerText = "üåπüåπüåπüåπüåπüåπüåπüåπüåπüåπüåπüåπ";
                    MoveTop();
                    isShowed = true;
                }
            }
            document.onreadystatechange = () => {
                document.getElementById("EasterEggs").addEventListener("click", showEasterEggs);
            }
        </script>
        EOF
        sed -i "s! ‚ù§! <span id="EasterEggs">‚ù§</span>! g" ./CoreHome.HomePage/Views/Shared/_Layout.cshtml
    - name: Build CoreHome.HomePage
      run: docker build --file ./CoreHome.HomePage/Dockerfile --tag lixinyang/corehome-homepage:home .

    - name: Push image to DockerHub
      run: |
        docker login -u lixinyang -p ${{ secrets.DOCKERHUB_PASSWORD }}
        docker push lixinyang/corehome-homepage:home
        docker logout
    
    - name: Push image to aliyun
      run: |
        docker login -u=lllxyÂïäÂïäÂïä -p ${{ secrets.DOCKERHUB_PASSWORD }} registry.cn-shenzhen.aliyuncs.com
        docker tag lixinyang/corehome-homepage:home registry.cn-shenzhen.aliyuncs.com/lllxy/corehome-homepage:home
        docker push registry.cn-shenzhen.aliyuncs.com/lllxy/corehome-homepage:home
        docker logout
